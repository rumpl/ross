# Development Dockerfile for ross
# Usage:
#   docker build -f Dockerfile.dev -t ross-dev .
#   docker run -it --rm --privileged -v /tmp/ross-data:/tmp/ross -p 50051:50051 ross-dev daemon
#
# For CLI:
#   docker run --rm --network host ross-dev cli health
#   docker run --rm --network host ross-dev cli run hello-world

FROM rust:alpine AS builder

RUN apk add --no-cache \
    musl-dev \
    protobuf-dev \
    openssl-dev \
    openssl-libs-static \
    pkgconf \
    protoc

WORKDIR /build

COPY Cargo.toml Cargo.lock ./
COPY cli/Cargo.toml cli/Cargo.toml
COPY container/Cargo.toml container/Cargo.toml
COPY core/Cargo.toml core/Cargo.toml
COPY daemon/Cargo.toml daemon/Cargo.toml
COPY image/Cargo.toml image/Cargo.toml
COPY mount/Cargo.toml mount/Cargo.toml
COPY remote/Cargo.toml remote/Cargo.toml
COPY shim/Cargo.toml shim/Cargo.toml
COPY snapshotter/Cargo.toml snapshotter/Cargo.toml
COPY store/Cargo.toml store/Cargo.toml

COPY proto proto
COPY . .

RUN --mount=type=cache,target=/build/target \
    --mount=type=cache,target=/usr/local/cargo/registry \
    --mount=type=cache,target=/usr/local/cargo/git \
    cargo build --release && \
    cp target/release/ross-daemon target/release/ross-cli /tmp/

FROM alpine:latest

RUN apk add --no-cache \
    runc \
    fuse-overlayfs \
    ca-certificates

COPY --from=builder /tmp/ross-daemon /usr/local/bin/
COPY --from=builder /tmp/ross-cli /usr/local/bin/

ENV RUST_LOG=info,ross=debug

EXPOSE 50051

COPY docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

ENTRYPOINT ["docker-entrypoint.sh"]
CMD ["daemon"]
